name: CI

on:
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    name: SwiftLint
    runs-on: macos-14
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install SwiftLint
        run: brew install swiftlint
      
      - name: Run SwiftLint
        run: |
          cd CopilotMonitor/CopilotMonitor
          swiftlint lint --reporter github-actions-logging
        continue-on-error: true

  actionlint:
    name: GitHub Actions Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Install actionlint
        run: |
          curl -sL https://github.com/rhysd/actionlint/releases/download/v1.7.7/actionlint_1.7.7_linux_amd64.tar.gz | tar xzv -C /tmp
          sudo mv /tmp/actionlint /usr/local/bin/
      
      - name: Run actionlint
        run: actionlint -color

  build:
    name: Build
    runs-on: macos-14
    needs: [lint, actionlint]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4'
      
      - name: Resolve Swift Packages
        run: |
          cd CopilotMonitor
          xcodebuild -resolvePackageDependencies \
            -project CopilotMonitor.xcodeproj \
            -scheme CopilotMonitor
      
      - name: Build (Debug)
        run: |
          cd CopilotMonitor
          xcodebuild build \
            -project CopilotMonitor.xcodeproj \
            -scheme CopilotMonitor \
            -configuration Debug \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
      
      - name: Build (Release)
        run: |
          cd CopilotMonitor
          xcodebuild build \
            -project CopilotMonitor.xcodeproj \
            -scheme CopilotMonitor \
            -configuration Release \
            -destination 'platform=macOS' \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO
